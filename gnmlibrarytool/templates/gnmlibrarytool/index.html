{% themeextends "base.html" %}
{% load static from staticfiles %}
{% block title %}Vidispine Library Management{% endblock %}

{% block head %}
<style>
    div.container { margin-left: 8px; overflow: hidden;  }
    div.list_selector_item { display: inline; overflow: hidden; margin-bottom: 4px; }

    span.headline { font-size: 1em; font-weight: bold; }
    span.library_info { font-size: 0.7em; font-weight: normal }
    p.error { color: red; };
</style>
<link rel="stylesheet" href='{% static "codemirror/lib/codemirror.css" %}'>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/globalize/0.1.1/globalize.min.js"></script>
<script type="text/javascript" src="/sitemedia/js/chartjs/Lib/js/dx.chartjs.js"></script>
<script src='{% static "codemirror/lib/codemirror.js" %}'></script>
<script src='{% static "codemirror/mode/xml/xml.js" %}'></script>

<script language="JavaScript">
var selector_page_size=15;
var selector_page=0;

var graph_data = [];

/*updates the barchart based on data downloaded from populate_library_selector*/
function update_graph()
{
if(! graph_data || graph_data.length==0) return;

console.log(graph_data);
$('#libraries_graph').dxChart({
    size: {
        height: 250
    },
    dataSource: graph_data,
    series: {
        type: 'bar',
        valueField: 'hits'
    },
    commonSeriesSettings: {
        argumentField: 'id',
        label: {
            visible: true,
            format: 'fixedPoint',
            precision: 0
        }
    },
    title: 'Items found by libraries',
    legend: {
        visible: false,
        verticalAlignment: 'bottom',
        horizontalAlignment: 'center'
    }
});
$('#graph_loading_indicator').hide();
}

function list_selector_click(vsid)
{
var uri = "/gnmlibrarytool/" + vsid;
window.location.href = uri;
}

function empty_library_selector()
{
$('#library_selector_container').html("");
graph_data = [];
selector_page=0;
}

function populate_library_selector()
{
$('#library_selector_loading_indicator').show();

var listArgs = "s="+selector_page_size + "&p="+selector_page;
if($('#id_only_auto_refreshing').is(':checked')){
    listArgs += ";autoRefresh=true";
}

$.getJSON("endpoint/list?"+listArgs)
    .success(function(data){
        str = "<div class=\"list_selector_static\">Total: " + data['total'] + "</div>";
        $.each(data['results'], function(idx,ptr){
            str += "<div class=\"list_selector_item\" onMouseOver=\"list_selector_mouseover(this);\" onclick=\"list_selector_click('"+ptr['id']+"');\">";
            str += "<span class=\"headline\">"+ptr['id']+"</span><br>";
            str += "<span class=\"library_info\">Containing "+ptr['hits']+" items</span><br>";
            str += "</div>";
            graph_data.push(ptr);
        });
        existing_content = $('#library_selector_container').html();
        $('#library_selector_container').html(existing_content+str);
        update_graph();
        $('#library_selector_loading_indicator').hide();
    })
    .fail(function(jqXHR, textStatus, errorThrown){
        $('#library_selector_container').html("<p class=\"error\">" + errorThrown + ": " + textStatus + "</p>");
        selector_page = 0;
        $('#library_selector_loading_indicator').hide();
    });
}

$(document).ready(function() {
    populate_library_selector();
    var search_def_editor = CodeMirror.fromTextArea(document.getElementById('id_search_definition'), {
        lineNumbers: true,
        lineWrapping: true
    });
    var storage_rule_editor = CodeMirror.fromTextArea(document.getElementById('id_storage_rule_definition'), {
        lineNumbers: true,
        lineWrapping: true
    });
});
</script>
{% endblock %}

{% block body %}
<h1>Vidispine Library Management</h1>
<p class="debug">{{ debug_notes }}</p>
<div class="container" style="height: 30%; width=100%; margin-bottom: 20px;" id="top_row">
    <div style="width: 15%; overflow: hidden; float: left" id="search_form_container">
        <ul>
        {{ search_form.as_ul }}
        </ul>
        <button onclick="empty_library_selector(); populate_library_selector();">Update</button>
        <div id="library_selector_loading_indicator" style="display: hidden;">
            <p><img src="/sitemedia/img/gnm/loading.gif" alt="loading...">Refreshing libraries...</p>
        </div>
    </div>
    <div style="width:73%; overflow: hidden; float: right" id="graph_container">
        <div id="graph_loading_indicator" style="display: hidden;">
            <p><img src="/sitemedia/img/gnm/loading.gif" alt="loading...">Waiting for data...</p>
        </div>
        <div id="libraries_graph">

        </div>
    </div>
</div>

<div class="container" style="height: 70%; width=100%;" id="bottom_row">
    <div style="width: 15%; overflow: hidden; float: left" id="library_selector_container">
    </div>
    <div style="width:73%; overflow: hidden; float: right" id="config_form_container">
        {% if not configuration_form %}
        <p>Select a library definition from the list on the left to see and edit details</p>
        {% endif %}
        {% if configuration_form_error %}
        <p class="error">{{ configuration_form_error }}</p>
        {% else %}
        <table>
        {{ configuration_form.as_table }}
        </table>
        {% endif %}
    </div>
</div>
{% endblock %}